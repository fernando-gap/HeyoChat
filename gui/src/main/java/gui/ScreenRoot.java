/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JFrame.java to edit this template
 */
package gui;

import java.awt.SystemColor;
import java.io.IOException;
import java.io.InputStream;
import java.io.ObjectOutputStream;
import java.net.Socket;

import javax.swing.DefaultListModel;
import javax.swing.ListModel;
import javax.swing.SwingUtilities;

import shared.client.Message;
import shared.client.User;
import shared.communication.Action;
import shared.communication.Receiver;
import shared.communication.Response;
import shared.communication.Sender;

/**
 *
 * @author god
 */
public class ScreenRoot extends javax.swing.JFrame {

    /**
     * Creates new form TestJFrame
     */
    public ScreenRoot(Socket socket) throws IOException {
        this.socket = socket;
        this.socket = socket;
        InputStream in = socket.getInputStream();
        server = new MessageFromServer(in);
        server.setRoot(this);
        serverThread = new Thread(server);

        screenAuth = new ScreenAuthentication();
        screenChat = new ScreenChat();

        screenAuth.setRoot(this);
        screenChat.setRoot(this);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        removeUserDialog = new javax.swing.JDialog();
        jLabel3 = new javax.swing.JLabel();
        RemoveUserDialogTextField = new javax.swing.JTextField();
        RemoveUserDialogButton = new javax.swing.JButton();
        statusRemoveUserDialogLabel1 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        cancelRemoveUserDialogButton = new javax.swing.JButton();
        addUserDialog = new javax.swing.JDialog();
        jLabel1 = new javax.swing.JLabel();
        addUserDialogTextField = new javax.swing.JTextField();
        addUserDialogButton = new javax.swing.JButton();
        statusAddUserDialogLabel = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        cancelAddUserDialogButton = new javax.swing.JButton();
        jScrollPane3 = new javax.swing.JScrollPane();
        addUserDialogTextArea = new javax.swing.JTextArea();
        jLabel5 = new javax.swing.JLabel();
        jSplitPane1 = new javax.swing.JSplitPane();
        jScrollPane1 = new javax.swing.JScrollPane();
        contactList = new javax.swing.JList<>();
        jScrollPane2 = new javax.swing.JScrollPane();
        jMenuBar1 = new javax.swing.JMenuBar();
        jMenu1 = new javax.swing.JMenu();
        jMenuItem1 = new javax.swing.JMenuItem();
        jMenuItem2 = new javax.swing.JMenuItem();
        jMenu2 = new javax.swing.JMenu();

        jLabel3.setText("Username");

        RemoveUserDialogTextField.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                RemoveUserDialogTextFieldActionPerformed(evt);
            }
        });

        RemoveUserDialogButton.setText("Remove");
        RemoveUserDialogButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                RemoveUserDialogButtonActionPerformed(evt);
            }
        });

        statusRemoveUserDialogLabel1.setEnabled(false);

        jLabel4.setText("Remove User");

        cancelRemoveUserDialogButton.setText("Cancel");
        cancelRemoveUserDialogButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cancelRemoveUserDialogButtonActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout removeUserDialogLayout = new javax.swing.GroupLayout(removeUserDialog.getContentPane());
        removeUserDialog.getContentPane().setLayout(removeUserDialogLayout);
        removeUserDialogLayout.setHorizontalGroup(
            removeUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(removeUserDialogLayout.createSequentialGroup()
                .addGroup(removeUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(removeUserDialogLayout.createSequentialGroup()
                        .addGap(71, 71, 71)
                        .addGroup(removeUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(statusRemoveUserDialogLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 272, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addGroup(removeUserDialogLayout.createSequentialGroup()
                                .addGroup(removeUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                                    .addGroup(removeUserDialogLayout.createSequentialGroup()
                                        .addComponent(cancelRemoveUserDialogButton)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                        .addComponent(RemoveUserDialogButton))
                                    .addGroup(removeUserDialogLayout.createSequentialGroup()
                                        .addComponent(jLabel3)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                        .addComponent(RemoveUserDialogTextField, javax.swing.GroupLayout.PREFERRED_SIZE, 200, javax.swing.GroupLayout.PREFERRED_SIZE)))
                                .addGap(12, 12, 12))))
                    .addGroup(removeUserDialogLayout.createSequentialGroup()
                        .addContainerGap()
                        .addComponent(jLabel4)))
                .addContainerGap(45, Short.MAX_VALUE))
        );
        removeUserDialogLayout.setVerticalGroup(
            removeUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(removeUserDialogLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel4)
                .addGap(90, 90, 90)
                .addGroup(removeUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel3)
                    .addComponent(RemoveUserDialogTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(removeUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(RemoveUserDialogButton)
                    .addComponent(cancelRemoveUserDialogButton))
                .addGap(35, 35, 35)
                .addComponent(statusRemoveUserDialogLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(52, Short.MAX_VALUE))
        );

        jLabel1.setText("Username");

        addUserDialogTextField.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                addUserDialogTextFieldActionPerformed(evt);
            }
        });

        addUserDialogButton.setText("Add");
        addUserDialogButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                addUserDialogButtonActionPerformed(evt);
            }
        });

        statusAddUserDialogLabel.setEnabled(false);

        jLabel2.setText("Add User");

        cancelAddUserDialogButton.setText("Cancel");
        cancelAddUserDialogButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cancelAddUserDialogButtonActionPerformed(evt);
            }
        });

        addUserDialogTextArea.setColumns(20);
        addUserDialogTextArea.setRows(5);
        jScrollPane3.setViewportView(addUserDialogTextArea);

        jLabel5.setText("Message");

        javax.swing.GroupLayout addUserDialogLayout = new javax.swing.GroupLayout(addUserDialog.getContentPane());
        addUserDialog.getContentPane().setLayout(addUserDialogLayout);
        addUserDialogLayout.setHorizontalGroup(
            addUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(addUserDialogLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel2)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, addUserDialogLayout.createSequentialGroup()
                .addGap(0, 78, Short.MAX_VALUE)
                .addGroup(addUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(statusAddUserDialogLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 272, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(addUserDialogLayout.createSequentialGroup()
                        .addComponent(cancelAddUserDialogButton)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(addUserDialogButton))
                    .addGroup(addUserDialogLayout.createSequentialGroup()
                        .addGroup(addUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(jLabel1)
                            .addComponent(jLabel5))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(addUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(jScrollPane3, javax.swing.GroupLayout.DEFAULT_SIZE, 257, Short.MAX_VALUE)
                            .addComponent(addUserDialogTextField))))
                .addGap(68, 68, 68))
        );
        addUserDialogLayout.setVerticalGroup(
            addUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(addUserDialogLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel2)
                .addGap(33, 33, 33)
                .addGroup(addUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(addUserDialogTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(addUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel5))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(addUserDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(addUserDialogButton)
                    .addComponent(cancelAddUserDialogButton))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(statusAddUserDialogLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(40, Short.MAX_VALUE))
        );

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);

        jSplitPane1.setDividerLocation(300);

        contactList.setModel(new javax.swing.AbstractListModel<String>() {
            String[] strings = { "Item 1", "Item 2", "Item 3", "Item 4", "Item 5" };
            public int getSize() { return strings.length; }
            public String getElementAt(int i) { return strings[i]; }
        });
        jScrollPane1.setViewportView(contactList);

        jSplitPane1.setLeftComponent(jScrollPane1);
        jSplitPane1.setRightComponent(jScrollPane2);

        jMenu1.setText("User");

        jMenuItem1.setText("Add User");
        jMenuItem1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jMenuItem1ActionPerformed(evt);
            }
        });
        jMenu1.add(jMenuItem1);

        jMenuItem2.setText("Remove User");
        jMenuItem2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jMenuItem2ActionPerformed(evt);
            }
        });
        jMenu1.add(jMenuItem2);

        jMenuBar1.add(jMenu1);

        jMenu2.setText("Group");
        jMenuBar1.add(jMenu2);

        setJMenuBar(jMenuBar1);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jSplitPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 1012, Short.MAX_VALUE)
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jSplitPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 730, Short.MAX_VALUE)
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jMenuItem1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jMenuItem1ActionPerformed
        // TODO add your handling code here:
        addUserDialog.pack();
        addUserDialog.setVisible(true);
    }//GEN-LAST:event_jMenuItem1ActionPerformed

    private void addUserDialogTextFieldActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_addUserDialogTextFieldActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_addUserDialogTextFieldActionPerformed

    private void cancelAddUserDialogButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cancelAddUserDialogButtonActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_cancelAddUserDialogButtonActionPerformed

    private void RemoveUserDialogTextFieldActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_RemoveUserDialogTextFieldActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_RemoveUserDialogTextFieldActionPerformed

    private void cancelRemoveUserDialogButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cancelRemoveUserDialogButtonActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_cancelRemoveUserDialogButtonActionPerformed

    private void jMenuItem2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jMenuItem2ActionPerformed
        // TODO add your handling code here:
        removeUserDialog.pack();
        removeUserDialog.setVisible(true);
    }//GEN-LAST:event_jMenuItem2ActionPerformed

    private void RemoveUserDialogButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_RemoveUserDialogButtonActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_RemoveUserDialogButtonActionPerformed

    private void addUserDialogButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_addUserDialogButtonActionPerformed
        // TODO add your handling code here:
        String name = addUserDialogTextField.getText();
        String textArea = addUserDialogTextArea.getText();
        
        statusAddUserDialogLabel.setVisible(false);
        
        if (name.equals("")) {
            statusAddUserDialogLabel.setText("Username can't be empty.");
            statusAddUserDialogLabel.setVisible(true);
            return;
        }
        
        if (textArea.equals("")) {
            statusAddUserDialogLabel.setText("Message can't be empty");
            statusAddUserDialogLabel.setVisible(true);
            return;
        }
        
        try {
            if (isAuthorized) {
                Sender<Message> sender = new Sender<>(currentUser.getName(), name, Action.ADD_USER_LIST);
                sender.appendData(new Message(textArea));
                ObjectOutputStream out = new ObjectOutputStream(socket.getOutputStream());
                out.writeObject(sender);
            } else {
                statusAddUserDialogLabel.setText("Forbidden.");
                statusAddUserDialogLabel.setVisible(true);
                return;
            }
        } catch (IOException e) {
            statusAddUserDialogLabel.setEnabled(true);
            statusAddUserDialogLabel.setVisible(true);
            statusAddUserDialogLabel.setText("[ERROR]: " + e.toString());
        }
        
    }//GEN-LAST:event_addUserDialogButtonActionPerformed

    public void start() {
        System.out.println("hello");
        serverThread.start();
        add(screenAuth);
        pack();
        setVisible(true);
        System.out.println("bye");
    }

    public Socket getSocket() {
        return socket;
    }

    public void handleUpdate(Receiver<?> receiver) {
        System.err.println(receiver.getAction() + " " + receiver.getResponse());
        if (receiver.getResponse() != Response.ERROR) {
            switch (receiver.getAction()) {
                case SIGN_IN:
                    handleLogin(receiver);
                    break;
                case ADD_USER_LIST:
                    addToContactList(receiver);
                    break;
            }
        } else {
            System.err.println("ERROR. UNFORTUNATELY");
        }
    }

    private void handleLogin(Receiver<?> receiver) {
        SwingUtilities.invokeLater(new Runnable() {
            @Override
            public void run() {
                if (isAuthorized) {
                    return;
                }

                isAuthorized = true;
                currentUser = (User) receiver.getData(0);
                remove(screenAuth);
                initComponents();
            }
        });
    }

    private void addToContactList(Receiver<?> receiver) {
        String username = (String) receiver.getData(0);
        System.out.println(username);
        SwingUtilities.invokeLater(new Runnable() {
            @Override
            public void run() {
                DefaultListModel<String> list = (DefaultListModel<String>) contactList.getModel();
                list.addElement(username);
            }
        });
    }
    

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        SwingUtilities.invokeLater(new Runnable() {
            @Override
            public void run() {
                try {
                    Socket socket = new Socket("localhost", 5000);
                    ScreenRoot root = new ScreenRoot(socket);
                    root.start();
                } catch (IOException e) {
                    System.err.println(e);
                }
            }
        });
    }

    private Socket socket;
    private MessageFromServer server;
    private Thread serverThread;
    private ScreenAuthentication screenAuth;
    private ScreenChat screenChat;
    private User currentUser;
    private boolean isAuthorized = false;

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton RemoveUserDialogButton;
    private javax.swing.JTextField RemoveUserDialogTextField;
    private javax.swing.JDialog addUserDialog;
    private javax.swing.JButton addUserDialogButton;
    private javax.swing.JTextArea addUserDialogTextArea;
    private javax.swing.JTextField addUserDialogTextField;
    private javax.swing.JButton cancelAddUserDialogButton;
    private javax.swing.JButton cancelRemoveUserDialogButton;
    private javax.swing.JList<String> contactList;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JMenu jMenu1;
    private javax.swing.JMenu jMenu2;
    private javax.swing.JMenuBar jMenuBar1;
    private javax.swing.JMenuItem jMenuItem1;
    private javax.swing.JMenuItem jMenuItem2;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JSplitPane jSplitPane1;
    private javax.swing.JDialog removeUserDialog;
    private javax.swing.JLabel statusAddUserDialogLabel;
    private javax.swing.JLabel statusRemoveUserDialogLabel1;
    // End of variables declaration//GEN-END:variables
}
